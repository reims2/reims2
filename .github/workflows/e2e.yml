name: E2E test

on:
  workflow_call:
  schedule:
    - cron: "7 15 * * 6"

concurrency: e2e-test

jobs:
  e2e-deploy:
    name: "Deploy E2E instance"
    uses: reims2/reims2/.github/workflows/deploy-instance.yml@main
    secrets: inherit # pass all secrets
    with:
      instance_name: e2e

  e2e:
    runs-on: ubuntu-latest
    needs: e2e-deploy
    defaults:
      run:
        working-directory: ./e2e
    steps:
      - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4
      - uses: actions/setup-node@0a44ba7841725637a19e28fa30b79a866c81b0a6 # v4
        with:
          node-version-file: "e2e/.nvmrc"
          cache: "yarn"
          cache-dependency-path: "e2e/yarn.lock"
      - name: Install dependencies
        run: yarn install --immutable
      - name: Install Playwright Browsers (chromium only)
        if: github.event_name != 'schedule' && github.event_name != 'workflow_dispatch'
        run: yarn playwright install --with-deps chromium
      - name: Install Playwright Browsers (all)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: yarn playwright install --with-deps
      - name: Run fast test suite
        if: github.event_name != 'schedule' && github.event_name != 'workflow_dispatch'
        run: yarn playwright test --project chromium --grep @fast
        env:
          BASE_URL: "https://e2e.reims2.app"
      - name: Run all tests
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: yarn playwright test
        env:
          BASE_URL: "https://e2e.reims2.app"
      - uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4
        if: always()
        with:
          name: playwright-report
          path: |
            e2e/playwright-report/
            e2e/test-results/
          retention-days: 14
      - name: Stop E2E instance
        if: always()
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        with:
          host: reims2.app
          username: actions
          key: ${{ secrets.RM_DEPLOY_KEY }}
          port: 22
          script: reims2-e2e
